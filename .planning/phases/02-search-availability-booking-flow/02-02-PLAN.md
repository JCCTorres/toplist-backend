---
phase: 02-search-availability-booking-flow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/api.js
  - src/pages/PropertyDetails.jsx
  - src/features/home/components/ContactSection/ContactForm.jsx
  - src/features/home/components/ManagementSection/ManagementForm.jsx
autonomous: true

must_haves:
  truths:
    - "Book Now button redirects to Airbnb checkout with dates and guests pre-filled"
    - "Clear message indicates booking completes on Airbnb"
    - "Properties without airbnb_id show contact fallback instead of Book Now"
    - "Contact form submits to API and shows success/error feedback"
    - "Management form submits to API and shows success/error feedback"
  artifacts:
    - path: "src/services/api.js"
      provides: "getAirbnbCheckoutUrl, sendContactEmail, sendManagementEmail methods"
      contains: "getAirbnbCheckoutUrl"
    - path: "src/pages/PropertyDetails.jsx"
      provides: "Working Book Now with Airbnb redirect"
      contains: "getAirbnbCheckoutUrl"
    - path: "src/features/home/components/ContactSection/ContactForm.jsx"
      provides: "API-connected contact form"
      contains: "sendContactEmail"
    - path: "src/features/home/components/ManagementSection/ManagementForm.jsx"
      provides: "API-connected management form"
      contains: "sendManagementEmail"
  key_links:
    - from: "src/pages/PropertyDetails.jsx"
      to: "api.getAirbnbCheckoutUrl"
      via: "handleBookNow click handler"
      pattern: "getAirbnbCheckoutUrl.*airbnb_id"
    - from: "src/features/home/components/ContactSection/ContactForm.jsx"
      to: "api.sendContactEmail"
      via: "form submit handler"
      pattern: "sendContactEmail"
    - from: "src/features/home/components/ManagementSection/ManagementForm.jsx"
      to: "api.sendManagementEmail"
      via: "form submit handler"
      pattern: "sendManagementEmail"
---

<objective>
Wire Book Now to Airbnb checkout redirect and connect contact/management forms to email APIs.

Purpose: Complete the booking flow by redirecting to Airbnb, and enable guest/owner inquiries via email.
Output: Working Book Now redirect, functional contact form, functional management inquiry form.
</objective>

<execution_context>
@C:\Users\joao_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\joao_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-search-availability-booking-flow/02-RESEARCH.md

# Phase 1 established patterns
@.planning/phases/01-api-connection-data-wiring/01-01-SUMMARY.md
@.planning/phases/01-api-connection-data-wiring/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Airbnb checkout and email API methods</name>
  <files>src/services/api.js</files>
  <action>
Add three new methods to api object in src/services/api.js.

Insert these methods after searchProperties (or after getPropertyAvailability if 02-01 hasn't run yet):

```javascript
/**
 * Generate Airbnb checkout URL with pre-filled dates/guests
 * @param {string} airbnbId - Airbnb listing ID
 * @param {Object} params - { checkin, checkout, numberOfAdults, numberOfChildren }
 * @returns {Promise<{success: boolean, data: {checkout_url: string}}>}
 */
getAirbnbCheckoutUrl: async (airbnbId, params) => {
  const response = await fetch(`${BASE_URL}/airbnb/${airbnbId}/checkout-link`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      checkin: params.checkin,
      checkout: params.checkout,
      numberOfGuests: (parseInt(params.numberOfAdults) || 1) + (parseInt(params.numberOfChildren) || 0),
      numberOfAdults: parseInt(params.numberOfAdults) || 1,
      numberOfChildren: parseInt(params.numberOfChildren) || 0
    })
  });
  return handleResponse(response);
},

/**
 * Send contact form email
 * @param {Object} data - { name, email, phone, message }
 * @returns {Promise<{success: boolean, message: string}>}
 */
sendContactEmail: async (data) => {
  const response = await fetch('/api/email/contact', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return handleResponse(response);
},

/**
 * Send management inquiry email
 * @param {Object} data - { name, email, propertyType, bedrooms, message }
 * @returns {Promise<{success: boolean, message: string}>}
 */
sendManagementEmail: async (data) => {
  const response = await fetch('/api/email/management-request', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return handleResponse(response);
},
```

Note: sendContactEmail and sendManagementEmail use '/api/email/...' (no BASE_URL) because email endpoints are at root /api, not /api/bookerville.
  </action>
  <verify>Run `grep -n "getAirbnbCheckoutUrl\|sendContactEmail\|sendManagementEmail" src/services/api.js` - should show all 3 methods</verify>
  <done>api.js has getAirbnbCheckoutUrl, sendContactEmail, and sendManagementEmail methods</done>
</task>

<task type="auto">
  <name>Task 2: Wire Book Now button to Airbnb redirect</name>
  <files>src/pages/PropertyDetails.jsx</files>
  <action>
Update PropertyDetails.jsx to handle Book Now click with Airbnb redirect.

Changes needed:

1. Add state for guest counts and booking status at top of component (after existing useState calls):
   ```javascript
   const [guestCount, setGuestCount] = useState(2);
   const [childrenCount, setChildrenCount] = useState(0);
   const [bookingLoading, setBookingLoading] = useState(false);
   ```

2. Add date formatting helper (near getNightsCount function):
   ```javascript
   const formatDate = (date) => date.toISOString().split('T')[0];
   ```

3. Add handleBookNow function (after getNightsCount function):
   ```javascript
   const handleBookNow = async () => {
     // Check if property has Airbnb listing
     if (!property.airbnb_id) {
       alert('This property cannot be booked online. Please contact us to make a reservation.');
       return;
     }

     // Validate dates selected
     if (selectedDates.length !== 2) {
       alert('Please select check-in and check-out dates before booking.');
       return;
     }

     setBookingLoading(true);
     try {
       const response = await api.getAirbnbCheckoutUrl(property.airbnb_id, {
         checkin: formatDate(selectedDates[0]),
         checkout: formatDate(selectedDates[1]),
         numberOfAdults: guestCount,
         numberOfChildren: childrenCount
       });

       if (response.success && response.data?.checkout_url) {
         // Open Airbnb in new tab
         window.open(response.data.checkout_url, '_blank');
       } else {
         alert('Unable to generate booking link. Please try again or contact us.');
       }
     } catch (err) {
       console.error('Booking error:', err);
       alert('An error occurred. Please try again or contact us to book.');
     } finally {
       setBookingLoading(false);
     }
   };
   ```

4. Update the Adults select to use controlled state:
   ```jsx
   <div>
     <label className="block text-sm font-medium mb-1">Adults</label>
     <select
       className="w-full p-2 border border-gray-300 rounded"
       value={guestCount}
       onChange={(e) => setGuestCount(parseInt(e.target.value))}
     >
       <option value="1">1 adult</option>
       <option value="2">2 adults</option>
       <option value="3">3 adults</option>
       <option value="4">4 adults</option>
       <option value="5">5 adults</option>
       <option value="6">6 adults</option>
     </select>
   </div>
   ```

5. Update the Children select to use controlled state:
   ```jsx
   <div>
     <label className="block text-sm font-medium mb-1">Children</label>
     <select
       className="w-full p-2 border border-gray-300 rounded"
       value={childrenCount}
       onChange={(e) => setChildrenCount(parseInt(e.target.value))}
     >
       <option value="0">0 children</option>
       <option value="1">1 child</option>
       <option value="2">2 children</option>
       <option value="3">3 children</option>
       <option value="4">4 children</option>
     </select>
   </div>
   ```

6. Add Airbnb notice component before the Book Now button:
   ```jsx
   {/* Airbnb Redirect Notice */}
   <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
     <div className="flex items-start">
       <svg className="w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
         <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
       </svg>
       <p className="text-sm text-blue-700">
         <strong>Secure Booking:</strong> You will be redirected to Airbnb to complete your reservation securely.
       </p>
     </div>
   </div>
   ```

7. Replace the existing Book Now button with conditional rendering:
   ```jsx
   {property.airbnb_id ? (
     <button
       onClick={handleBookNow}
       disabled={bookingLoading}
       className="w-full bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
     >
       {bookingLoading ? 'Preparing Booking...' : 'Book Now on Airbnb'}
     </button>
   ) : (
     <div className="text-center">
       <p className="text-gray-600 mb-3">This property requires direct booking.</p>
       <Link
         to="/contact"
         className="w-full block bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition-colors text-center"
       >
         Contact Us to Book
       </Link>
     </div>
   )}
   ```

8. Remove the "Total Guests" select since we now have separate Adults/Children selects (remove lines 479-493 approximately - the div containing "Total Guests" label and select).

9. Also remove the step indicators (the div with green circles showing 1, 2) since they're not functional - lines 513-520 approximately.
  </action>
  <verify>
1. Run `grep -n "handleBookNow\|getAirbnbCheckoutUrl" src/pages/PropertyDetails.jsx` - should show both
2. Run `grep -n "Book Now on Airbnb" src/pages/PropertyDetails.jsx` - should show button text
3. Run `grep -n "Secure Booking" src/pages/PropertyDetails.jsx` - should show Airbnb notice
  </verify>
  <done>Book Now calls Airbnb checkout API and opens result in new tab; properties without airbnb_id show contact fallback; Airbnb redirect notice is visible</done>
</task>

<task type="auto">
  <name>Task 3: Wire ContactForm to email API</name>
  <files>src/features/home/components/ContactSection/ContactForm.jsx</files>
  <action>
Rewrite ContactForm.jsx to use controlled inputs and submit to email API.

Replace entire file content with:

```jsx
import React, { useState } from 'react';
import { api } from '../../../../services/api';

const ContactForm = () => {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    message: ''
  });
  const [submitting, setSubmitting] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.id]: e.target.value });
    setError(''); // Clear error when user types
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Basic validation
    if (!formData.name || !formData.email || !formData.phone || !formData.message) {
      setError('Please fill in all fields');
      return;
    }

    setSubmitting(true);
    setError('');

    try {
      const result = await api.sendContactEmail(formData);
      if (result.success) {
        setSuccess(true);
        setFormData({ name: '', email: '', phone: '', message: '' });
      } else {
        setError(result.message || 'Failed to send message. Please try again.');
      }
    } catch (err) {
      console.error('Contact form error:', err);
      setError('Failed to send message. Please try again later.');
    } finally {
      setSubmitting(false);
    }
  };

  if (success) {
    return (
      <div className="bg-white rounded-lg shadow-md p-8">
        <div className="bg-green-50 border border-green-200 rounded-lg p-8 text-center">
          <svg className="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 className="text-xl font-semibold text-green-800 mb-2">Message Sent!</h3>
          <p className="text-green-700 mb-4">Thank you for contacting us. We'll get back to you soon.</p>
          <button
            onClick={() => setSuccess(false)}
            className="text-green-600 hover:text-green-800 underline font-medium"
          >
            Send another message
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow-md p-8">
      <form onSubmit={handleSubmit}>
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
            {error}
          </div>
        )}
        <div className="mb-4">
          <label htmlFor="name" className="block text-gray-700 font-medium mb-2">Your Name</label>
          <input
            type="text"
            id="name"
            value={formData.name}
            onChange={handleChange}
            placeholder="Type your name"
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          />
        </div>
        <div className="mb-4">
          <label htmlFor="email" className="block text-gray-700 font-medium mb-2">Email Address</label>
          <input
            type="email"
            id="email"
            value={formData.email}
            onChange={handleChange}
            placeholder="Type your email"
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          />
        </div>
        <div className="mb-4">
          <label htmlFor="phone" className="block text-gray-700 font-medium mb-2">Phone Number</label>
          <input
            type="tel"
            id="phone"
            value={formData.phone}
            onChange={handleChange}
            placeholder="Type your phone number"
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          />
        </div>
        <div className="mb-6">
          <label htmlFor="message" className="block text-gray-700 font-medium mb-2">Your Message</label>
          <textarea
            id="message"
            rows="5"
            value={formData.message}
            onChange={handleChange}
            placeholder="Type your message"
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          ></textarea>
        </div>
        <button
          type="submit"
          disabled={submitting}
          className="w-full bg-pink-400 text-white py-3 px-6 rounded-lg hover:bg-pink-500 transition-all duration-300 shadow-lg font-medium text-lg disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {submitting ? 'Sending...' : 'Send Message'}
        </button>
      </form>
    </div>
  );
};

export default ContactForm;
```
  </action>
  <verify>Run `grep -n "sendContactEmail\|submitting\|success" src/features/home/components/ContactSection/ContactForm.jsx` - should show API call and state</verify>
  <done>ContactForm uses controlled inputs, calls sendContactEmail API, shows loading/success/error states</done>
</task>

<task type="auto">
  <name>Task 4: Wire ManagementForm to email API</name>
  <files>src/features/home/components/ManagementSection/ManagementForm.jsx</files>
  <action>
Rewrite ManagementForm.jsx to use controlled inputs and submit to email API.

Replace entire file content with:

```jsx
import React, { useState } from 'react';
import { api } from '../../../../services/api';

const ManagementForm = () => {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    propertyType: '',
    bedrooms: '',
    message: ''
  });
  const [submitting, setSubmitting] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.id]: e.target.value });
    setError('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Basic validation
    if (!formData.name || !formData.email) {
      setError('Please provide your name and email');
      return;
    }

    setSubmitting(true);
    setError('');

    try {
      const result = await api.sendManagementEmail(formData);
      if (result.success) {
        setSuccess(true);
        setFormData({ name: '', email: '', propertyType: '', bedrooms: '', message: '' });
      } else {
        setError(result.message || 'Failed to send request. Please try again.');
      }
    } catch (err) {
      console.error('Management form error:', err);
      setError('Failed to send request. Please try again later.');
    } finally {
      setSubmitting(false);
    }
  };

  if (success) {
    return (
      <div className="bg-gray-100 p-8 rounded-lg shadow-md">
        <div className="bg-green-50 border border-green-200 rounded-lg p-8 text-center">
          <svg className="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 className="text-xl font-semibold text-green-800 mb-2">Request Sent!</h3>
          <p className="text-green-700 mb-4">Thank you for your interest! We'll contact you shortly with management information.</p>
          <button
            onClick={() => setSuccess(false)}
            className="text-green-600 hover:text-green-800 underline font-medium"
          >
            Submit another inquiry
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-gray-100 p-8 rounded-lg shadow-md">
      <h3 className="text-xl font-semibold mb-4 text-center text-gray-900">Request Management Info</h3>
      <form onSubmit={handleSubmit}>
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
            {error}
          </div>
        )}
        <div className="mb-4">
          <label htmlFor="name" className="block text-gray-700 font-medium mb-2">Your Name</label>
          <input
            type="text"
            id="name"
            value={formData.name}
            onChange={handleChange}
            placeholder="Type your name"
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          />
        </div>
        <div className="mb-4">
          <label htmlFor="email" className="block text-gray-700 font-medium mb-2">Email Address</label>
          <input
            type="email"
            id="email"
            value={formData.email}
            onChange={handleChange}
            placeholder="Type your email"
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          />
        </div>
        <div className="mb-4">
          <label htmlFor="propertyType" className="block text-gray-700 font-medium mb-2">Property Type</label>
          <select
            id="propertyType"
            value={formData.propertyType}
            onChange={handleChange}
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white"
          >
            <option value="">Select Property Type</option>
            <option value="condo">Condo</option>
            <option value="townhouse">Townhouse</option>
            <option value="villa">Villa</option>
            <option value="house">Single Family Home</option>
          </select>
        </div>
        <div className="mb-4">
          <label htmlFor="bedrooms" className="block text-gray-700 font-medium mb-2">Number of Bedrooms</label>
          <select
            id="bedrooms"
            value={formData.bedrooms}
            onChange={handleChange}
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white"
          >
            <option value="">Select Bedrooms</option>
            <option value="1-2">1-2 Bedrooms</option>
            <option value="3-4">3-4 Bedrooms</option>
            <option value="5-6">5-6 Bedrooms</option>
            <option value="7+">7+ Bedrooms</option>
          </select>
        </div>
        <div className="mb-4">
          <label htmlFor="message" className="block text-gray-700 font-medium mb-2">Additional Information (Optional)</label>
          <textarea
            id="message"
            rows="3"
            value={formData.message}
            onChange={handleChange}
            placeholder="Tell us about your property..."
            className="w-full border-2 border-pink-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white placeholder-gray-400"
          ></textarea>
        </div>
        <button
          type="submit"
          disabled={submitting}
          className="w-full bg-pink-400 text-white py-3 px-6 rounded-lg hover:bg-pink-500 transition-all duration-300 shadow-lg font-medium text-lg disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {submitting ? 'Sending...' : 'Request Information'}
        </button>
      </form>
    </div>
  );
};

export default ManagementForm;
```
  </action>
  <verify>Run `grep -n "sendManagementEmail\|submitting\|success" src/features/home/components/ManagementSection/ManagementForm.jsx` - should show API call and state</verify>
  <done>ManagementForm uses controlled inputs, calls sendManagementEmail API, shows loading/success/error states</done>
</task>

</tasks>

<verification>
After all tasks:
1. Start dev server: `npm run dev`

**Test Book Now:**
2. Go to any property detail page
3. Select dates in the calendar
4. Select adults and children counts
5. Click "Book Now on Airbnb"
6. Should open new tab with Airbnb checkout URL containing dates and guest counts

**Test Contact Form:**
7. Go to Contact page or scroll to contact section on Home
8. Fill in all fields and submit
9. Should show "Sending..." then success message
10. Try submitting empty form - should show error

**Test Management Form:**
11. Go to Management section on Home page
12. Fill in name/email and submit
13. Should show success message

**Test fallback for properties without Airbnb:**
14. If any property lacks airbnb_id, Book Now should be replaced with "Contact Us to Book" link
</verification>

<success_criteria>
- Book Now opens Airbnb checkout in new tab with dates/guests pre-filled
- Airbnb redirect notice visible above Book Now button
- Properties without airbnb_id show "Contact Us to Book" fallback
- Contact form submits, shows loading state, then success or error
- Management form submits, shows loading state, then success or error
- All forms prevent double-submit with disabled button while loading
</success_criteria>

<output>
After completion, create `.planning/phases/02-search-availability-booking-flow/02-02-SUMMARY.md`
</output>
