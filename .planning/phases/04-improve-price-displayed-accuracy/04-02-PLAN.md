---
phase: 04-improve-price-displayed-accuracy
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - Toplist Final/toplist-main/toplist-main/src/services/api.js
  - Toplist Final/toplist-main/toplist-main/src/components/PriceDisplay.jsx
  - Toplist Final/toplist-main/toplist-main/src/components/PriceBreakdown.jsx
  - Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx
autonomous: true

must_haves:
  truths:
    - "PropertyDetails page shows estimated total when dates are selected"
    - "Price breakdown is visible showing nightly rate, cleaning fee, taxes, and Airbnb fee"
    - "Prices update when user changes dates or guest count"
    - "Loading state is shown while price is being fetched"
    - "Disclaimer about final price at Airbnb checkout is displayed"
    - "Error state displays gracefully if price fetch fails"
  artifacts:
    - path: "Toplist Final/toplist-main/toplist-main/src/services/api.js"
      provides: "getPriceEstimate API method"
      contains: "getPriceEstimate"
    - path: "Toplist Final/toplist-main/toplist-main/src/components/PriceDisplay.jsx"
      provides: "Reusable price display component"
      exports: ["PriceDisplay"]
    - path: "Toplist Final/toplist-main/toplist-main/src/components/PriceBreakdown.jsx"
      provides: "Detailed price breakdown component with error state"
      exports: ["PriceBreakdown"]
    - path: "Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx"
      provides: "Property details page with integrated pricing"
      contains: "PriceBreakdown"
  key_links:
    - from: "Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx"
      to: "Toplist Final/toplist-main/toplist-main/src/services/api.js"
      via: "api.getPriceEstimate call"
      pattern: "api\\.getPriceEstimate"
    - from: "Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx"
      to: "Toplist Final/toplist-main/toplist-main/src/components/PriceBreakdown.jsx"
      via: "component import"
      pattern: "import.*PriceBreakdown"
---

<objective>
Create frontend price display components and integrate into PropertyDetails page.

Purpose: Display accurate price estimates with full fee breakdown on the property details page when users select dates.
Output: New PriceDisplay.jsx and PriceBreakdown.jsx components, updated api.js and PropertyDetails.jsx.
</objective>

<execution_context>
@C:\Users\joao_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\joao_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-improve-price-displayed-accuracy/04-RESEARCH.md
@.planning/phases/04-improve-price-displayed-accuracy/04-01-SUMMARY.md
@Toplist Final/toplist-main/toplist-main/src/services/api.js
@Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getPriceEstimate to api.js</name>
  <files>Toplist Final/toplist-main/toplist-main/src/services/api.js</files>
  <action>
Add a new method to the api object, placing it after the `getPropertyAvailability` method:

```javascript
/**
 * Get price estimate for a property stay
 * @param {string} propertyId - Property ID
 * @param {Object} params - { checkIn, checkOut, guests }
 * @returns {Promise<{success: boolean, data: Object}>}
 */
getPriceEstimate: async (propertyId, params) => {
  const response = await fetch(`${BASE_URL}/properties/${propertyId}/price-estimate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      checkIn: params.checkIn,
      checkOut: params.checkOut,
      guests: params.guests || 2
    })
  });
  return handleResponse(response);
},
```

Find the `getPropertyAvailability` method and add the new method immediately after it.
  </action>
  <verify>Check file contains getPriceEstimate method: `grep -n "getPriceEstimate" "Toplist Final/toplist-main/toplist-main/src/services/api.js"`</verify>
  <done>api.js exports getPriceEstimate method that POSTs to /api/bookerville/properties/{id}/price-estimate</done>
</task>

<task type="auto">
  <name>Task 2: Create PriceBreakdown component with error state</name>
  <files>Toplist Final/toplist-main/toplist-main/src/components/PriceBreakdown.jsx</files>
  <action>
Create a new React component that displays the full price breakdown with loading, error, and success states:

```jsx
import React from 'react';

/**
 * Displays detailed price breakdown for a property stay
 * @param {Object} price - Price estimate from API
 * @param {boolean} loading - Loading state
 * @param {string} error - Error message if fetch failed
 */
const PriceBreakdown = ({ price, loading, error }) => {
  if (loading) {
    return (
      <div className="animate-pulse space-y-3">
        <div className="h-4 bg-white/10 rounded w-full"></div>
        <div className="h-4 bg-white/10 rounded w-3/4"></div>
        <div className="h-4 bg-white/10 rounded w-full"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="text-sand-200/60 text-sm">
        <p>Unable to calculate price estimate.</p>
        <p className="text-xs text-sand-200/40 mt-1">Final price will be shown at Airbnb checkout.</p>
      </div>
    );
  }

  if (!price) {
    return null;
  }

  // Format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: price.currency || 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  };

  return (
    <div className="space-y-3">
      {/* Nightly rate */}
      <div className="flex justify-between text-sm">
        <span className="text-sand-200/70">
          {formatCurrency(price.nightly_avg)} x {price.nights} night{price.nights !== 1 ? 's' : ''}
        </span>
        <span className="text-white">{formatCurrency(price.base_price)}</span>
      </div>

      {/* Cleaning fee */}
      {price.cleaning_fee > 0 && (
        <div className="flex justify-between text-sm">
          <span className="text-sand-200/70">Cleaning fee</span>
          <span className="text-white">{formatCurrency(price.cleaning_fee)}</span>
        </div>
      )}

      {/* Additional guest fee */}
      {price.additional_guest_fee > 0 && (
        <div className="flex justify-between text-sm">
          <span className="text-sand-200/70">Additional guest fee</span>
          <span className="text-white">{formatCurrency(price.additional_guest_fee)}</span>
        </div>
      )}

      {/* Taxes */}
      {price.tax_amount > 0 && (
        <div className="flex justify-between text-sm">
          <span className="text-sand-200/70">
            Taxes ({price.tax_rate}%)
          </span>
          <span className="text-white">{formatCurrency(price.tax_amount)}</span>
        </div>
      )}

      {/* Airbnb service fee estimate */}
      {price.estimated_airbnb_fee > 0 && (
        <div className="flex justify-between text-sm text-sand-200/50">
          <span>Est. Airbnb service fee</span>
          <span>{formatCurrency(price.estimated_airbnb_fee)}</span>
        </div>
      )}

      {/* Divider */}
      <div className="border-t border-white/10 pt-3 mt-3">
        <div className="flex justify-between font-semibold">
          <span className="text-white">Estimated Total</span>
          <span className="text-gold-400 text-lg">{formatCurrency(price.estimated_total)}</span>
        </div>
      </div>

      {/* Disclaimer */}
      <p className="text-xs text-sand-200/40 mt-2">
        Final price confirmed at checkout on Airbnb
      </p>
    </div>
  );
};

export default PriceBreakdown;
```

The component matches the existing dark theme with Tailwind classes and handles error states gracefully.
  </action>
  <verify>File exists and exports component: `head -5 "Toplist Final/toplist-main/toplist-main/src/components/PriceBreakdown.jsx"`</verify>
  <done>PriceBreakdown.jsx exists with loading state, error state, full breakdown display, and Airbnb disclaimer</done>
</task>

<task type="auto">
  <name>Task 3: Integrate price estimate into PropertyDetails page</name>
  <files>Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx</files>
  <action>
Modify PropertyDetails.jsx to fetch and display price estimates.

NOTE: The file already has a `formatDate` helper function (line 104: `const formatDate = (date) => date.toISOString().split('T')[0];`), so no need to add it.

1. Add import at top with other imports:
   ```jsx
   import PriceBreakdown from '../components/PriceBreakdown';
   ```

2. Add state variables for price estimate. Find the state declarations section (where useState calls are grouped, after `const [showFullDescription, setShowFullDescription] = useState(false);`) and add:
   ```jsx
   const [priceEstimate, setPriceEstimate] = useState(null);
   const [loadingPrice, setLoadingPrice] = useState(false);
   const [priceError, setPriceError] = useState(null);
   ```

3. Add useEffect to fetch price when dates change. Find the section with existing useEffect hooks (after the `useEffect` that handles `availability.error`) and add:
   ```jsx
   // Fetch price estimate when dates and property are available
   useEffect(() => {
     const fetchPriceEstimate = async () => {
       if (selectedDates.length !== 2 || !property?.id) return;

       setLoadingPrice(true);
       setPriceError(null);
       try {
         const result = await api.getPriceEstimate(property.id, {
           checkIn: formatDate(selectedDates[0]),
           checkOut: formatDate(selectedDates[1]),
           guests: guestCount + childrenCount
         });
         if (result.success) {
           setPriceEstimate(result.data);
         } else {
           setPriceError('Unable to fetch price');
           setPriceEstimate(null);
         }
       } catch (err) {
         console.warn('Failed to fetch price estimate:', err);
         setPriceError('Unable to fetch price');
         setPriceEstimate(null);
       } finally {
         setLoadingPrice(false);
       }
     };

     fetchPriceEstimate();
   }, [selectedDates, guestCount, childrenCount, property?.id]);
   ```

4. Replace the booking sidebar price section. Find the div in the booking sidebar that contains "Base Price:" and "Total per night:" text (inside the `<div className="bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-6 sticky top-24">` section). The current structure looks like:
   ```jsx
   <div className="mb-4">
     <div className="flex justify-between items-center mb-2">
       <span className="font-medium text-sand-200/60">Base Price:</span>
       <span className="text-white">{getDisplayPrice()}/night</span>
     </div>
     <div className="flex justify-between items-center">
       <span className="font-medium text-sand-200/60">Total per night:</span>
       <span className="font-bold text-white">{getDisplayPrice()}</span>
     </div>
   </div>
   ```

   Replace it with:
   ```jsx
   <div className="mb-4">
     {priceEstimate || loadingPrice || priceError ? (
       <PriceBreakdown price={priceEstimate} loading={loadingPrice} error={priceError} />
     ) : (
       <div className="flex justify-between items-center">
         <span className="font-medium text-sand-200/60">From:</span>
         <span className="text-white font-semibold">{getDisplayPrice()}/night</span>
       </div>
     )}
   </div>
   ```

This shows the basic nightly rate before dates are selected, then switches to full breakdown once dates are chosen, with error handling if the API fails.
  </action>
  <verify>
1. Check import: `grep -n "import PriceBreakdown" "Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx"`
2. Check state: `grep -n "priceEstimate\|priceError" "Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx"`
3. Check useEffect: `grep -n "fetchPriceEstimate" "Toplist Final/toplist-main/toplist-main/src/pages/PropertyDetails.jsx"`
4. Build check: `cd "Toplist Final/toplist-main/toplist-main" && npm run build` (if available)
  </verify>
  <done>PropertyDetails.jsx fetches price estimate on date change, shows PriceBreakdown with error handling when dates selected, falls back to base rate otherwise</done>
</task>

</tasks>

<verification>
1. api.js contains getPriceEstimate method
2. PriceBreakdown.jsx exists and is valid JSX with error prop handling
3. PropertyDetails.jsx imports and uses PriceBreakdown with error state
4. No JavaScript syntax errors in modified files
5. Manual test: Navigate to property details, select dates, see price breakdown appear
6. Error test: If API fails, graceful error message is shown instead of crash
</verification>

<success_criteria>
- Selecting dates on PropertyDetails triggers price estimate fetch
- PriceBreakdown shows: nightly rate x nights, cleaning fee, taxes, Airbnb estimate, total
- Loading skeleton shows while fetching
- Error state shows graceful message if API fails
- Disclaimer "Final price confirmed at checkout on Airbnb" is visible
- Before dates selected, shows "From: $X/night" using existing getDisplayPrice
</success_criteria>

<output>
After completion, create `.planning/phases/04-improve-price-displayed-accuracy/04-02-SUMMARY.md`
</output>
