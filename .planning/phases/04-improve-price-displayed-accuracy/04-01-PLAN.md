---
phase: 04-improve-price-displayed-accuracy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Services/PriceCalculatorService.php
  - app/Http/Controllers/Api/BookervilleController.php
  - routes/api.php
autonomous: true

must_haves:
  truths:
    - "API returns calculated price estimate when given dates, guests, and property ID"
    - "Price estimate includes nightly rates, cleaning fee, taxes, and estimated Airbnb fee"
    - "Seasonal rates are correctly applied based on check-in date"
    - "Weekend nights are calculated using property's weekend_nights field"
  artifacts:
    - path: "app/Services/PriceCalculatorService.php"
      provides: "Price calculation logic"
      exports: ["calculateStayPrice", "findApplicableRate", "countWeekendNights"]
    - path: "routes/api.php"
      provides: "Price estimate endpoint registration"
      contains: "price-estimate"
  key_links:
    - from: "app/Http/Controllers/Api/BookervilleController.php"
      to: "app/Services/PriceCalculatorService.php"
      via: "service instantiation"
      pattern: "PriceCalculatorService"
    - from: "app/Http/Controllers/Api/BookervilleController.php"
      to: "app/Services/BookervilleService.php"
      via: "getPropertyDetails call"
      pattern: "getPropertyDetails"
---

<objective>
Create backend price calculation service and API endpoint.

Purpose: Enable frontend to fetch accurate stay price estimates including all fees and taxes for a given property, date range, and guest count.
Output: New PriceCalculatorService.php, updated BookervilleController.php with getPriceEstimate method, and route registration.
</objective>

<execution_context>
@C:\Users\joao_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\joao_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-improve-price-displayed-accuracy/04-RESEARCH.md
@app/Services/BookervilleService.php
@app/Http/Controllers/Api/BookervilleController.php
@routes/api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PriceCalculatorService</name>
  <files>app/Services/PriceCalculatorService.php</files>
  <action>
Create a new service class with the following methods:

1. `calculateStayPrice(array $rates, array $fees, string $checkIn, string $checkOut, int $guests = 2, int $freeGuests = 2): array`
   - Calculate number of nights using Carbon
   - Find applicable rate for the check-in date using `findApplicableRate()`
   - Count weekend vs weekday nights using `countWeekendNights()`
   - Calculate base price: (weekdayNights * nightly_rate) + (weekendNights * weekend_rate)
   - Add cleaning_fee from fees
   - Add additional_guest_fee if guests > freeGuests: (extra guests * fee * nights)
   - Calculate subtotal (base + cleaning + additional guest)
   - Calculate tax_amount: subtotal * (tax_rate / 100)
   - Calculate estimated Airbnb service fee: subtotal * 0.142 (14.2% average guest fee)
   - Return associative array with:
     - nights, weekday_nights, weekend_nights
     - nightly_avg (base_price / nights, rounded to 2 decimals)
     - base_price, cleaning_fee, additional_guest_fee
     - subtotal, tax_amount, tax_rate
     - estimated_airbnb_fee, estimated_total
     - currency (from fees or 'USD')

2. `findApplicableRate(array $rates, string $checkIn): ?array`
   - Parse check-in date with Carbon
   - Loop through rates, find first where check-in is between start_date and end_date
   - Fallback to first rate if no match

3. `countWeekendNights(string $checkIn, string $checkOut, string $weekendNights = 'Fri|Sat'): int`
   - Parse weekend nights string (e.g., 'Fri|Sat' or 'Fri|Sat|Sun')
   - Loop through each night in the stay
   - Count nights that fall on weekend days (0=Sunday, 5=Friday, 6=Saturday)
   - Return count

Use `use Carbon\Carbon;` for date operations. All monetary values should be rounded to 2 decimal places.
  </action>
  <verify>
Run `php artisan tinker` and test:
```php
$calc = new \App\Services\PriceCalculatorService();
$rates = [['start_date' => '2025-01-01', 'end_date' => '2025-12-31', 'nightly_rate' => 200, 'weekend_rate' => 250, 'weekend_nights' => 'Fri|Sat']];
$fees = ['cleaning_fee' => 150, 'tax_rate' => 13.5, 'additional_guest_fee' => 25];
$result = $calc->calculateStayPrice($rates, $fees, '2025-03-14', '2025-03-17', 4, 2);
print_r($result);
```
Should return array with nights=3, weekend_nights=2, weekday_nights=1, and calculated totals.
  </verify>
  <done>PriceCalculatorService exists with calculateStayPrice, findApplicableRate, and countWeekendNights methods. Manual tinker test confirms correct calculation.</done>
</task>

<task type="auto">
  <name>Task 2: Add price estimate endpoint to BookervilleController and routes</name>
  <files>app/Http/Controllers/Api/BookervilleController.php, routes/api.php</files>
  <action>
1. In BookervilleController.php, add a new method `getPriceEstimate`:
   - Inject PriceCalculatorService via `new PriceCalculatorService()` (or constructor)
   - Validate request: checkIn (required, date Y-m-d), checkOut (required, date Y-m-d after checkIn), guests (optional, integer min 1, default 2)
   - Call $this->bookervilleService->getPropertyDetails(['propertyId' => $propertyId])
   - If not successful, return 400 with error
   - Extract $rates = $details['data']['rates'] ?? []
   - Extract $fees = $details['data']['fees'] ?? []
   - Call $priceCalculator->calculateStayPrice($rates, $fees, $checkIn, $checkOut, $guests)
   - Return JSON response with success: true, data: $estimate

2. In routes/api.php, add the route inside the `/bookerville` prefix group (around line 146-155):
   ```php
   Route::post('/properties/{propertyId}/price-estimate', [BookervilleController::class, 'getPriceEstimate']);
   ```
   This makes the endpoint: POST /api/bookerville/properties/{id}/price-estimate

Add the use statement for PriceCalculatorService at the top of BookervilleController if not using constructor injection.
  </action>
  <verify>
Test with curl:
```bash
curl -X POST "http://localhost:8000/api/bookerville/properties/8558/price-estimate" \
  -H "Content-Type: application/json" \
  -d '{"checkIn": "2025-03-14", "checkOut": "2025-03-17", "guests": 2}'
```
Should return JSON with success: true and data containing nights, base_price, cleaning_fee, tax_amount, estimated_total, etc.
  </verify>
  <done>POST /api/bookerville/properties/{propertyId}/price-estimate returns price breakdown with all fee components</done>
</task>

</tasks>

<verification>
1. `php artisan route:list | grep price-estimate` shows the new route
2. API returns valid price estimate for test property with dates
3. Price calculation includes cleaning fee, taxes, and Airbnb estimate
4. No PHP syntax errors: `php -l app/Services/PriceCalculatorService.php`
</verification>

<success_criteria>
- PriceCalculatorService.php exists and calculates correct price breakdowns
- API endpoint /api/bookerville/properties/{id}/price-estimate works
- Response includes: nights, nightly_avg, base_price, cleaning_fee, tax_amount, estimated_airbnb_fee, estimated_total
- Weekend/weekday calculation respects property's weekend_nights configuration
</success_criteria>

<output>
After completion, create `.planning/phases/04-improve-price-displayed-accuracy/04-01-SUMMARY.md`
</output>
